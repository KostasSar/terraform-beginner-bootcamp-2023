# Terraform Beginner Bootcamp 2023

## AWS

### Credentials and environment variables

For quick and secure access to the AWS environment, the credentials and cli preferences can be set as evironment variables.

After appending the following to the `~/.bash_profile` file using your favorite text editor.

```bash
export AWS_ACCESS_KEY_ID={KEY_ID_VALUE}
export AWS_SECRET_ACCESS_KEY={SECRET_KEY_VALUE}
export AWS_DEFAULT_REGION=eu-east-3
export AWS_CLI_AUTO_PROMPT=on-partial
```

Then to apply the changes without reopening the terminal, execute

```bash
source ~/.bash_profile
```

### CloudFront Price Class

CloudFront edge locations are grouped into geographic regions. Having content distributed from more edge locations increases the cost but reduces latency.
Choosing a lower price class will not prevent regions from accessing content but will increase latency depending on the user location and the price class in use.


## Terraform 

### Workspace Variables

After migrating the tf state file to Terraform Cloud, the local environment variables are no longer accessible by the worker that will create, destroy or modify any infrastructure. Therefore, these variables must be declared on Terraform Cloud to make them available and avoid failing changes due to invalid / missing credentials.

On Terraform Cloud, after selecting the current workspace, head to the `Variables` section and add your Access Key.

![Terraform Cloud variables screenshot example for Access Key ](image.png)

### Terraform destroy and apply

After the AWS credentials were added in the Terraform Cloud Workspace, I performed a destroy and re-apply to test that everything is in place.


```bash
terraform destroy
```
This deleted the S3 bucket that was previously created, as well as the first randomly generated string which is a **managed resource** too.


```bash
terraform apply
```
This created a new S3 bucket with a different random suffix included in the name.


### TF Cloud Login Issue Fix

When trying to login to Terraform Cloud I discovered that all the login issues we faced with GitPod in the videos can be solved by pressing `CTRL+c`.
This was stopping the prompts and menus generated and just pointed to a prompt asking for the token.
After pasing, I go the **Successful login** message!
No need for workarounds or the additional bash script.


### File structure
`main.tf`, `variables.tf`, `outputs.tf`. These are the recommended filenames for a minimal module, even if they're empty. `main.tf` should be the primary entrypoint. For a simple module, this may be where all the resources are created. For a complex module, resource creation may be split into multiple files but any nested module calls should be in the main file. variables.tf and outputs.tf should contain the declarations for variables and outputs, respectively.

### Terraform Import

#### From CLI

The terraform import CLI command can only import resources into the state. Importing via the CLI does not generate configuration.

#### From Import Block

Add the new import block in a new file called `import.tf`. After specifying the target resource and its id, depending on the resource type, execute `terraform plan` to import the existing resource and a possible new resource block generated by Terraform. Verify and edit the new block before applying or pushing to git.

*This feature is only available on Terraform version 1.5.0 or later.*

### Terraform modules

Modules should be placed in a new directory named `modules` as per the module structure guide.

#### Module Variables and Outputs

Module variables and outputs declared and used within a module, must also be declared on the root level variables and outputs files respectively.
- For variables: There is no need to replicate the validation and error steps, just declaring the variable type is enough.
- For outputs: Output value on the root level, references the module to get its value.

### Terraform files and paths

It's possible to reference files and resources in the workspace using variables to avoid hardcoding file paths and making modules more versatile and adaptive.
Some good examples are:
* `path.root` is the filesystem path of the root module of the configuration.
* `terraform.workspace` is the name of the currently selected ***workspace***.

### Terraform Data Sources

Data sources allow Terraform to use information defined outside of Terraform, defined by another separate Terraform configuration, or modified by functions.

### Terraform fmt

The terraform fmt command is used to rewrite Terraform configuration files to a canonical format and style.
Makes files easy to read and modify.


### Terraform for_each

The for_each meta-argument accepts a map or a set of strings, and creates an instance for each item in that map or set. 
Each instance has a distinct infrastructure object associated with it, and each is separately created, updated, or destroyed when the configuration is applied.

### Image file referencing issues

When testing the first version of a static website with jpg files, there was an issue with finding the correct file path and load the images on the browser.
To resolve this:
1. The `content_type = "image/jpeg"` attribute was set for the newly uploaded image assets on the website S3 bucket.
2. Asset referencing in the `index.html` file was switched from absolute path to relative path.

After changing the content version, thus triggering the cache invalidation, and refreshing the webpage, the images were now included!

## Sources

* [Terraform Cloud - Managing Variables](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/variables/managing-variables#workspace-specific-variables)
* [Terraform Command: Destroy](https://developer.hashicorp.com/terraform/cli/commands/destroy)
* [Terraform Command: Apply](https://developer.hashicorp.com/terraform/cli/commands/apply)
* [AWS Environment Variables](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-envvars.html)
* [Terraform Registry - random_string](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/string)
* [Terraform Standard Module Structure](https://developer.hashicorp.com/terraform/language/modules/develop/structure)
* [Terraform Import](https://developer.hashicorp.com/terraform/language/import)
* [Terraform Filesystem and Workspace Info](https://developer.hashicorp.com/terraform/language/expressions/references#filesystem-and-workspace-info)
* [Terraform Data Sources](https://developer.hashicorp.com/terraform/language/data-sources)
* [AWS CloudFront Price Classes](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PriceClass.html)
* [Terraform fmt](https://developer.hashicorp.com/terraform/cli/commands/fmt)
* [Terraform for_each](https://developer.hashicorp.com/terraform/language/meta-arguments/for_each)
